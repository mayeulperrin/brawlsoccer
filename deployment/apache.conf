# Configuration Apache pour BrawlSoccer + Applications existantes
# /etc/apache2/sites-available/brawlsoccer.conf

<VirtualHost *:80>
    ServerName brawlsoccer.com
    ServerAlias www.brawlsoccer.com
    
    # Document Root pour vos applications PHP/HTML existantes
    DocumentRoot /var/www/html
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/brawlsoccer_error.log
    CustomLog ${APACHE_LOG_DIR}/brawlsoccer_access.log combined

    # ===== APPLICATIONS PHP/HTML EXISTANTES (racine) =====
    # Configuration PHP standard
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/var/run/php/php8.1-fpm.sock|fcgi://localhost/"
    </FilesMatch>

    # Index par défaut
    DirectoryIndex index.php index.html index.htm

    # Permissions pour le répertoire web
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # ===== BRAWLSOCCER - Proxy vers Node.js =====
    # Proxy pour l'application principale
    ProxyPreserveHost On
    ProxyPass /brawlsoccer/ http://127.0.0.1:3000/
    ProxyPassReverse /brawlsoccer/ http://127.0.0.1:3000/

    # WebSockets pour Socket.IO
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /brawlsoccer/(.*) ws://127.0.0.1:3000/$1 [P,L]
    
    # Support des WebSockets Socket.IO
    ProxyPass /brawlsoccer/socket.io/ http://127.0.0.1:3000/socket.io/
    ProxyPassReverse /brawlsoccer/socket.io/ http://127.0.0.1:3000/socket.io/

    # Headers pour les WebSockets et CORS
    <Location "/brawlsoccer/">
        ProxyPassReverse /
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header always set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization"
        
        # Support des WebSockets
        RewriteEngine On
        RewriteCond %{HTTP:Connection} Upgrade [NC]
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteRule /(.*) ws://127.0.0.1:3000/$1 [P,L]
    </Location>

    # ===== AUTRES APPLICATIONS PHP (exemples) =====
    # Exemple: Application dans un sous-dossier
    # <Directory /var/www/html/monapp>
    #     Options -Indexes +FollowSymLinks
    #     AllowOverride All
    #     Require all granted
    # </Directory>

    # ===== SÉCURITÉ =====
    # Bloquer l'accès aux fichiers sensibles
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>

    <FilesMatch "\.(env|htaccess|htpasswd|sh|bat)$">
        Require all denied
    </FilesMatch>

    # ===== OPTIMISATIONS =====
    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
    </IfModule>

    # Cache des ressources statiques
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/pdf "access plus 1 month"
        ExpiresByType text/x-javascript "access plus 1 month"
        ExpiresByType application/x-shockwave-flash "access plus 1 month"
        ExpiresByType image/x-icon "access plus 1 year"
        ExpiresDefault "access plus 2 days"
    </IfModule>

</VirtualHost>