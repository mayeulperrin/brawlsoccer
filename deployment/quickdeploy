#!/bin/bash
# QuickDeploy BrawlSoccer - Script Ã  exÃ©cuter sur le serveur
# TÃ©lÃ©charge et installe automatiquement depuis GitHub

set -e

# Configuration
GITHUB_REPO="https://github.com/mayeulperrin/brawlsoccer"
APP_NAME="brawlsoccer"
APP_DIR="/var/www/brawlsoccer"
SERVICE_NAME="brawlsoccer"
DOMAIN="brawlsoccer.com"
NODE_VERSION="18"

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# Fonctions
log() {
    echo -e "${BLUE}[$(date +'%H:%M:%S')]${NC} $1"
}

success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

error() {
    echo -e "${RED}âŒ $1${NC}"
    exit 1
}

step() {
    echo -e "${PURPLE}â”â”â” $1 â”â”â”${NC}"
}

# BanniÃ¨re
echo -e "${BLUE}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘        ğŸš€ BRAWLSOCCER QUICKDEPLOY      â•‘"
echo "â•‘     DÃ©ploiement automatique serveur   â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"

# VÃ©rifications prÃ©liminaires
if [[ $EUID -ne 0 ]]; then
   error "Ce script doit Ãªtre exÃ©cutÃ© en tant que root (sudo ./quickdeploy)"
fi

log "ğŸ¯ Configuration:"
echo "   â€¢ Repository: $GITHUB_REPO"
echo "   â€¢ Application: $APP_DIR"
echo "   â€¢ Domaine: $DOMAIN"
echo "   â€¢ Service: $SERVICE_NAME"
echo ""

read -p "Continuer le dÃ©ploiement ? (y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "1. INSTALLATION DES DÃ‰PENDANCES"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "ğŸ“¦ Mise Ã  jour du systÃ¨me..."
apt update -qq

log "ğŸ“¦ Installation de Node.js $NODE_VERSION..."
if ! command -v node &> /dev/null; then
    curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - &>/dev/null
    apt install -y nodejs &>/dev/null
fi

log "ğŸ“¦ Installation des services..."
apt install -y apache2 git curl unzip &>/dev/null

success "DÃ©pendances installÃ©es"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "2. TÃ‰LÃ‰CHARGEMENT DE L'APPLICATION"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "ğŸŒ TÃ©lÃ©chargement depuis GitHub..."

# Backup si existant
if [ -d "$APP_DIR" ]; then
    warning "Application existante trouvÃ©e"
    mv $APP_DIR ${APP_DIR}_backup_$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
fi

# Cloner le repository
mkdir -p $APP_DIR
cd $APP_DIR

log "ğŸ“¥ Clonage du repository..."
git clone $GITHUB_REPO . &>/dev/null || error "Impossible de cloner le repository"

success "Code tÃ©lÃ©chargÃ© depuis GitHub"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "3. COMPILATION ET INSTALLATION"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "ğŸ“¦ Installation des dÃ©pendances Node.js..."
npm install --production &>/dev/null

log "ğŸ”¨ Compilation de l'application..."
if [ -f "build.js" ]; then
    npm run build &>/dev/null || warning "Compilation Ã©chouÃ©e, utilisation des fichiers sources"
fi

success "Application compilÃ©e"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "4. CONFIGURATION APACHE"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "ğŸŒ Configuration d'Apache..."

# Activer les modules nÃ©cessaires
a2enmod proxy proxy_http proxy_wstunnel rewrite headers expires deflate &>/dev/null

# Personnaliser la configuration avec le bon domaine
if [ -f "deployment/apache.conf" ]; then
    sed -i "s/brawlsoccer\.com/$DOMAIN/g" deployment/apache.conf
    cp deployment/apache.conf /etc/apache2/sites-available/brawlsoccer.conf
    a2ensite brawlsoccer &>/dev/null
else
    warning "Fichier apache.conf non trouvÃ©, configuration manuelle nÃ©cessaire"
fi

success "Apache configurÃ©"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "5. SERVICE SYSTEMD"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "âš™ï¸ Configuration du service systemd..."

if [ -f "deployment/brawlsoccer.service" ]; then
    cp deployment/brawlsoccer.service /etc/systemd/system/
    systemctl daemon-reload
    systemctl enable $SERVICE_NAME &>/dev/null
else
    warning "Fichier service non trouvÃ©, crÃ©ation manuelle nÃ©cessaire"
fi

success "Service systemd configurÃ©"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "6. PERMISSIONS ET SÃ‰CURITÃ‰"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "ğŸ”’ Configuration des permissions..."

# Permissions de l'application
chown -R www-data:www-data $APP_DIR
chmod -R 755 $APP_DIR

# Dossiers de logs
mkdir -p /var/log/brawlsoccer
chown www-data:www-data /var/log/brawlsoccer

success "Permissions configurÃ©es"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "7. DÃ‰MARRAGE DES SERVICES"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "ğŸš€ DÃ©marrage des services..."

# Test de la configuration Apache
if apache2ctl configtest &>/dev/null; then
    systemctl reload apache2
    success "Apache rechargÃ©"
else
    warning "Erreur de configuration Apache, vÃ©rifiez manuellement"
fi

# DÃ©marrage de BrawlSoccer
if systemctl start $SERVICE_NAME &>/dev/null; then
    success "BrawlSoccer dÃ©marrÃ©"
else
    warning "Erreur de dÃ©marrage, vÃ©rifiez les logs: journalctl -u $SERVICE_NAME"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
step "8. VÃ‰RIFICATIONS FINALES"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "ğŸ” Tests de fonctionnement..."

sleep 3

# Test application Node.js
if curl -f http://localhost:3000 &>/dev/null; then
    success "Application Node.js rÃ©pond (port 3000)"
else
    warning "L'application ne rÃ©pond pas sur le port 3000"
fi

# Test proxy Apache
if curl -f http://localhost/brawlsoccer/ &>/dev/null; then
    success "Proxy Apache fonctionnel"
else
    warning "Proxy Apache non fonctionnel"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${GREEN}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘           ğŸ‰ DÃ‰PLOIEMENT TERMINÃ‰       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"

echo "ğŸ“‹ RÃ‰SUMÃ‰ DU DÃ‰PLOIEMENT:"
echo "   â€¢ Application: $APP_DIR"
echo "   â€¢ Configuration: /etc/apache2/sites-available/brawlsoccer.conf"
echo "   â€¢ Service: $SERVICE_NAME"
echo ""

echo "ğŸŒ ACCÃˆS:"
echo "   â€¢ Local: http://localhost/brawlsoccer/"
echo "   â€¢ Public: http://$DOMAIN/brawlsoccer/"
echo ""

echo "ğŸ”§ COMMANDES UTILES:"
echo "   â€¢ Statut: systemctl status $SERVICE_NAME"
echo "   â€¢ Logs: journalctl -u $SERVICE_NAME -f"
echo "   â€¢ RedÃ©marrer: systemctl restart $SERVICE_NAME"
echo "   â€¢ Logs Apache: tail -f /var/log/apache2/brawlsoccer_*.log"
echo ""

echo "ğŸ“ PROCHAINES Ã‰TAPES (optionnelles):"
echo "   1. Configurez HTTPS avec Let's Encrypt"
echo "   2. Configurez un firewall (ufw)"
echo "   3. Surveillez les performances"

success "BrawlSoccer est maintenant dÃ©ployÃ© et opÃ©rationnel ! ğŸ®"