#!/bin/bash
# QuickDeploy BrawlSoccer - Script à exécuter sur le serveur
# Télécharge et installe automatiquement depuis GitHub

set -e

# Configuration
GITHUB_REPO="https://github.com/mayeulperrin/brawlsoccer"
APP_NAME="brawlsoccer"
APP_DIR="/var/www/brawlsoccer"
SERVICE_NAME="brawlsoccer"
DOMAIN="brawlsoccer.com"
NODE_VERSION="18"

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# Fonctions
log() {
    echo -e "${BLUE}[$(date +'%H:%M:%S')]${NC} $1"
}

success() {
    echo -e "${GREEN}✅ $1${NC}"
}

warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

error() {
    echo -e "${RED}❌ $1${NC}"
    exit 1
}

step() {
    echo -e "${PURPLE}━━━ $1 ━━━${NC}"
}

# Bannière
echo -e "${BLUE}"
echo "╔═══════════════════════════════════════╗"
echo "║        🚀 BRAWLSOCCER QUICKDEPLOY      ║"
echo "║     Déploiement automatique serveur   ║"
echo "╚═══════════════════════════════════════╝"
echo -e "${NC}"

# Vérifications préliminaires
if [[ $EUID -ne 0 ]]; then
   error "Ce script doit être exécuté en tant que root (sudo ./quickdeploy)"
fi

log "🎯 Configuration:"
echo "   • Repository: $GITHUB_REPO"
echo "   • Application: $APP_DIR"
echo "   • Domaine: $DOMAIN"
echo "   • Service: $SERVICE_NAME"
echo ""

read -p "Continuer le déploiement ? (y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
fi

# ═══════════════════════════════════════════════════════════════
step "1. INSTALLATION DES DÉPENDANCES"
# ═══════════════════════════════════════════════════════════════

log "📦 Mise à jour du système..."
apt update -qq

log "📦 Installation de Node.js $NODE_VERSION..."
if ! command -v node &> /dev/null; then
    curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - &>/dev/null
    apt install -y nodejs &>/dev/null
fi

log "📦 Installation des services..."
apt install -y apache2 git curl unzip &>/dev/null

success "Dépendances installées"

# ═══════════════════════════════════════════════════════════════
step "2. TÉLÉCHARGEMENT DE L'APPLICATION"
# ═══════════════════════════════════════════════════════════════

log "🌐 Téléchargement depuis GitHub..."

# Backup si existant
if [ -d "$APP_DIR" ]; then
    warning "Application existante trouvée"
    mv $APP_DIR ${APP_DIR}_backup_$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
fi

# Cloner le repository
mkdir -p $APP_DIR
cd $APP_DIR

log "📥 Clonage du repository..."
git clone $GITHUB_REPO . &>/dev/null || error "Impossible de cloner le repository"

success "Code téléchargé depuis GitHub"

# ═══════════════════════════════════════════════════════════════
step "3. COMPILATION ET INSTALLATION"
# ═══════════════════════════════════════════════════════════════

log "📦 Installation des dépendances Node.js..."
npm install --production &>/dev/null

log "🔨 Compilation de l'application..."
if [ -f "build.js" ]; then
    npm run build &>/dev/null || warning "Compilation échouée, utilisation des fichiers sources"
fi

success "Application compilée"

# ═══════════════════════════════════════════════════════════════
step "4. CONFIGURATION APACHE"
# ═══════════════════════════════════════════════════════════════

log "🌐 Configuration d'Apache..."

# Activer les modules nécessaires
a2enmod proxy proxy_http proxy_wstunnel rewrite headers expires deflate &>/dev/null

# Personnaliser la configuration avec le bon domaine
if [ -f "deployment/apache.conf" ]; then
    sed -i "s/brawlsoccer\.com/$DOMAIN/g" deployment/apache.conf
    cp deployment/apache.conf /etc/apache2/sites-available/brawlsoccer.conf
    a2ensite brawlsoccer &>/dev/null
else
    warning "Fichier apache.conf non trouvé, configuration manuelle nécessaire"
fi

success "Apache configuré"

# ═══════════════════════════════════════════════════════════════
step "5. SERVICE SYSTEMD"
# ═══════════════════════════════════════════════════════════════

log "⚙️ Configuration du service systemd..."

if [ -f "deployment/brawlsoccer.service" ]; then
    cp deployment/brawlsoccer.service /etc/systemd/system/
    systemctl daemon-reload
    systemctl enable $SERVICE_NAME &>/dev/null
else
    warning "Fichier service non trouvé, création manuelle nécessaire"
fi

success "Service systemd configuré"

# ═══════════════════════════════════════════════════════════════
step "6. PERMISSIONS ET SÉCURITÉ"
# ═══════════════════════════════════════════════════════════════

log "🔒 Configuration des permissions..."

# Permissions de l'application
chown -R www-data:www-data $APP_DIR
chmod -R 755 $APP_DIR

# Dossiers de logs
mkdir -p /var/log/brawlsoccer
chown www-data:www-data /var/log/brawlsoccer

success "Permissions configurées"

# ═══════════════════════════════════════════════════════════════
step "7. DÉMARRAGE DES SERVICES"
# ═══════════════════════════════════════════════════════════════

log "🚀 Démarrage des services..."

# Test de la configuration Apache
if apache2ctl configtest &>/dev/null; then
    systemctl reload apache2
    success "Apache rechargé"
else
    warning "Erreur de configuration Apache, vérifiez manuellement"
fi

# Démarrage de BrawlSoccer
if systemctl start $SERVICE_NAME &>/dev/null; then
    success "BrawlSoccer démarré"
else
    warning "Erreur de démarrage, vérifiez les logs: journalctl -u $SERVICE_NAME"
fi

# ═══════════════════════════════════════════════════════════════
step "8. VÉRIFICATIONS FINALES"
# ═══════════════════════════════════════════════════════════════

log "🔍 Tests de fonctionnement..."

sleep 3

# Test application Node.js
if curl -f http://localhost:3000 &>/dev/null; then
    success "Application Node.js répond (port 3000)"
else
    warning "L'application ne répond pas sur le port 3000"
fi

# Test proxy Apache
if curl -f http://localhost/brawlsoccer/ &>/dev/null; then
    success "Proxy Apache fonctionnel"
else
    warning "Proxy Apache non fonctionnel"
fi

# ═══════════════════════════════════════════════════════════════
echo -e "${GREEN}"
echo "╔═══════════════════════════════════════╗"
echo "║           🎉 DÉPLOIEMENT TERMINÉ       ║"
echo "╚═══════════════════════════════════════╝"
echo -e "${NC}"

echo "📋 RÉSUMÉ DU DÉPLOIEMENT:"
echo "   • Application: $APP_DIR"
echo "   • Configuration: /etc/apache2/sites-available/brawlsoccer.conf"
echo "   • Service: $SERVICE_NAME"
echo ""

echo "🌐 ACCÈS:"
echo "   • Local: http://localhost/brawlsoccer/"
echo "   • Public: http://$DOMAIN/brawlsoccer/"
echo ""

echo "🔧 COMMANDES UTILES:"
echo "   • Statut: systemctl status $SERVICE_NAME"
echo "   • Logs: journalctl -u $SERVICE_NAME -f"
echo "   • Redémarrer: systemctl restart $SERVICE_NAME"
echo "   • Logs Apache: tail -f /var/log/apache2/brawlsoccer_*.log"
echo ""

echo "📝 PROCHAINES ÉTAPES (optionnelles):"
echo "   1. Configurez HTTPS avec Let's Encrypt"
echo "   2. Configurez un firewall (ufw)"
echo "   3. Surveillez les performances"

success "BrawlSoccer est maintenant déployé et opérationnel ! 🎮"